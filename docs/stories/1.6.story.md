# Story 1.6: 创建集成指南和最佳实践文档

## Status
Draft

## Story

**As a** 系统架构师,
**I want** 有集成指南和最佳实践文档,
**so that** 能够在生产环境中正确部署和优化系统。

## Acceptance Criteria

1. 创建`docs/integration.md`,包含:
   - Spring Security集成详细步骤(如何在现有Spring Security项目中集成)
   - Redis配置和连接池优化
   - 内存存储与Redis存储的选择建议
   - 多实例部署配置(分布式场景)
   - 与Spring Boot Actuator集成(健康检查、指标监控)
2. 创建`docs/best-practices.md`,包含:
   - Token过期策略选择指南(HardTimeout vs Timeout)
   - 性能优化建议(批量操作、缓存策略)
   - 安全性建议(Token长度、密钥管理、HTTPS)
   - 故障排查指南(常见错误和解决方案)
   - 监控和告警建议
3. 包含实际的配置示例和代码片段
4. 提供性能参考数据(如适用)

## Integration Validation

- IV1: 集成指南能够指导真实的系统集成
- IV2: 最佳实践建议基于实际代码能力和限制
- IV3: 故障排查指南覆盖常见问题

## Tasks / Subtasks

- [ ] **Task 1: 创建集成指南文档 (docs/integration.md)** (AC: 1, IV1)
  - [ ] 编写Spring Security集成步骤
    - [ ] 添加依赖配置(Maven/Gradle)
    - [ ] 自定义Security配置(扩展TokenSecurityConfig)
    - [ ] Token认证过滤器配置说明
    - [ ] 路径访问权限配置示例
    - [ ] 完整集成示例代码(含注释)
  - [ ] 编写Redis配置和优化指南
    - [ ] Redis基础配置(单机模式)
    - [ ] Redis集群配置(Cluster模式)
    - [ ] Redis哨兵配置(Sentinel模式)
    - [ ] Lettuce连接池优化参数说明
    - [ ] 性能调优建议(连接数、超时配置)
  - [ ] 编写存储选择建议
    - [ ] 内存存储 vs Redis存储对比表
    - [ ] 使用场景分析(单机/分布式/高可用)
    - [ ] 存储切换配置示例
    - [ ] 性能和资源消耗对比
  - [ ] 编写多实例部署配置
    - [ ] 负载均衡配置(Nginx示例)
    - [ ] Redis共享会话配置
    - [ ] 分布式锁配置说明
    - [ ] 健康检查配置
    - [ ] 集群部署架构图(文字描述)
  - [ ] 编写Spring Boot Actuator集成
    - [ ] 添加Actuator依赖
    - [ ] 暴露健康检查端点(/actuator/health)
    - [ ] 自定义健康指标(Token统计)
    - [ ] Prometheus指标集成(可选)
    - [ ] 监控端点安全配置

- [ ] **Task 2: 创建最佳实践文档 (docs/best-practices.md)** (AC: 2, IV2)
  - [ ] 编写Token过期策略选择指南
    - [ ] HardTimeoutToken vs TimeoutAccessToken对比
    - [ ] 使用场景建议(会话管理/API Token)
    - [ ] 过期时间推荐值(开发/生产环境)
    - [ ] 自定义过期策略示例
  - [ ] 编写性能优化建议
    - [ ] 缓存策略选择(Caffeine配置)
    - [ ] Redis性能优化(Pipeline、连接池)
    - [ ] Token ID长度优化建议
    - [ ] 批量操作最佳实践
    - [ ] JVM参数优化建议
  - [ ] 编写安全性建议
    - [ ] Token长度和强度要求
    - [ ] HTTPS传输配置(SSL/TLS)
    - [ ] Cookie安全属性(HttpOnly、Secure、SameSite)
    - [ ] CSRF保护配置
    - [ ] 敏感信息日志脱敏
  - [ ] 编写故障排查指南
    - [ ] Token认证失败(401错误)
    - [ ] Token过期处理
    - [ ] Redis连接失败
    - [ ] 自动配置未生效问题
    - [ ] 常见配置错误和解决方案
  - [ ] 编写监控和告警建议
    - [ ] 关键指标监控(Token数量、过期率)
    - [ ] Redis监控指标
    - [ ] 告警规则建议(阈值设置)
    - [ ] 日志记录最佳实践

- [ ] **Task 3: 添加配置示例和代码片段** (AC: 3)
  - [ ] 验证所有配置示例可用性
    - [ ] Spring Security集成配置示例
    - [ ] Redis连接配置示例(单机/集群/哨兵)
    - [ ] Actuator集成配置示例
    - [ ] 自定义Security配置代码示例
  - [ ] 确保所有代码片段完整可运行
    - [ ] 包含完整的import语句
    - [ ] 包含必要的注释说明
    - [ ] 包含异常处理代码
    - [ ] 提供YAML和Properties两种格式

- [ ] **Task 4: 添加性能参考数据** (AC: 4, IV2)
  - [ ] 收集性能基准数据
    - [ ] 内存存储性能数据(吞吐量/延迟)
    - [ ] Redis存储性能数据(吞吐量/延迟)
    - [ ] 不同Token长度性能影响
    - [ ] 缓存命中率影响
  - [ ] 提供资源消耗参考
    - [ ] 内存占用估算(不同Token数量)
    - [ ] Redis存储空间估算
    - [ ] JVM堆内存建议值
    - [ ] 连接池大小建议值

- [ ] **Task 5: 验证文档质量和准确性** (AC: 1, 2, 3, IV1, IV2, IV3)
  - [ ] 验证集成指南准确性
    - [ ] 按照集成步骤实际操作验证
    - [ ] 验证所有配置示例正确性
    - [ ] 确认架构图描述准确
  - [ ] 验证最佳实践建议可行性
    - [ ] 验证性能优化建议有效性
    - [ ] 验证安全性建议符合标准
    - [ ] 验证故障排查指南覆盖常见问题
  - [ ] 检查文档格式和链接
    - [ ] Markdown格式正确性
    - [ ] 代码块语法高亮
    - [ ] 内部链接和引用正确性
    - [ ] 表格格式美观性

- [ ] **Task 6: 更新文档索引** (AC: 1, 2)
  - [ ] 更新 `docs/README.md` 添加新文档链接
    - [ ] 添加集成指南链接
    - [ ] 添加最佳实践文档链接
    - [ ] 更新文档完成状态
    - [ ] 更新时间戳

## Dev Notes

### 前置故事上下文

**来自Story 1.5的关键学习:**
- ✅ 保持向后兼容和语义一致性至关重要
- ✅ 遵循官方指南和最佳实践可确保正确性
- ✅ 编译验证和测试验证都是必需的
- ✅ **文档应基于实际代码和架构,不能凭空捏造**
- ✅ 所有代码示例必须经过验证,确保可以直接运行
- ✅ 使用中文编写,保持术语一致性
- ✅ 表格展示信息简洁明了,便于查找
- ✅ 配置场景示例覆盖开发/生产/集群等多种环境

### Spring Security集成信息

[Source: docs/architecture/7-安全架构.md]

**核心安全组件:**
- `TokenSecurityConfig` - Security主配置类
  - 位置: `imaping-token-resource-client/src/main/java/com/imaping/token/resource/client/config/TokenSecurityConfig.java`
  - 提供默认的SecurityFilterChain配置
  - 支持扩展和自定义(通过继承)

- `TokenAuthenticationFilter` - Token认证过滤器
  - 位置: `imaping-token-resource-client/src/main/java/com/imaping/token/resource/client/filter/TokenAuthenticationFilter.java`
  - 提取Token的优先级: Header > Cookie > Parameter
  - 支持Bearer Token格式: `Authorization: Bearer <token>`

- `TokenAuthenticationProvider` - 认证提供者
  - 从TokenRegistry获取Token
  - 验证Token是否过期
  - 返回Authentication对象

- `TokenAuthenticationEntryPoint` - 认证入口点
  - 处理认证失败情况
  - 返回401 Unauthorized响应

**Token提取策略优先级:**
1. **HTTP Header** (最高优先级): `Authorization: Bearer <token>`
2. **Cookie**: `access_token=<token>`
3. **Request Parameter** (最低优先级): `?access_token=<token>`

**安全最佳实践:**
- Token长度 ≥ 32字符(256位熵)
- 使用Base64编码随机字节
- 生产环境强制HTTPS
- Cookie设置`Secure`、`HttpOnly`、`SameSite=Strict`属性
- 短期Token: 1-4小时(推荐值: 2小时 / 7200秒)

### Redis配置和部署信息

[Source: docs/architecture/6-部署架构.md]

**单机部署配置:**
```yaml
imaping:
  token:
    registry:
      redis:
        enabled: false            # 使用内存存储
      inMemory:
        cache: true               # 启用Caffeine缓存
        initialCapacity: 1000     # 初始容量
        loadFactor: 1             # 负载因子
        concurrency: 20           # 并发级别
    scheduling:
      enabled: true               # 启用定时清理
      repeatInterval: 120000      # 2分钟清理一次
```

**分布式部署配置(Redis):**
```yaml
imaping:
  token:
    registry:
      redis:
        enabled: true             # 使用Redis存储
      core:
        enable-locking: true      # 启用分布式锁
    scheduling:
      enabled: false              # Redis自动过期,无需定时清理

spring:
  data:
    redis:
      host: redis-cluster.example.com
      port: 6379
      password: ${REDIS_PASSWORD}
      database: 0
      lettuce:
        pool:
          max-active: 20          # 最大连接数
          max-idle: 10            # 最大空闲连接
          min-idle: 5             # 最小空闲连接
```

**Redis Key格式:**
```
imaping.token:{tokenId}:{userId}
```

**存储选择建议:**

| 存储后端 | 使用场景 | 优势 | 劣势 | 配置开关 |
|---------|---------|------|------|----------|
| **内存(ConcurrentHashMap)** | 单机应用、开发环境 | 快速、无外部依赖 | 无持久化、无集群支持、重启丢失 | `imaping.token.registry.redis.enabled=false` |
| **Redis** | 分布式应用、生产环境 | 持久化、集群共享、TTL自动过期、高可用 | 外部依赖、网络延迟 | `imaping.token.registry.redis.enabled=true` |

### Token过期策略信息

[Source: docs/architecture/4-核心组件.md, docs/api-guide.md]

**两种过期策略对比:**

| 策略类型 | 接口 | 实现类 | 行为特征 | 适用场景 |
|---------|------|--------|---------|---------|
| **自动续期** | `TimeoutAccessToken` | `DefaultTimeoutAccessToken` | 每次使用时更新lastTimeUsed,滑动窗口过期 | Web会话管理、需要保持活跃的用户会话 |
| **固定时间** | `HardTimeoutToken` | `DefaultHardTimeoutToken` | 从创建时间开始计算,固定时间过期 | API Token、短期访问令牌、一次性令牌 |

**过期策略实现类:**
- `TimeoutExpirationPolicy` - 自动续期策略(每次使用刷新)
- `HardTimeoutExpirationPolicy` - 固定时间策略(创建时间+TTL)

**过期时间配置:**
```yaml
imaping:
  token:
    accessToken:
      timeToKillInSeconds: 7200  # 2小时(生产环境推荐值)
```

**推荐配置:**
- 开发环境: 1-2小时
- 生产环境: 2-4小时
- ❌ 避免无限期Token

### 性能优化信息

[Source: docs/architecture/tech-stack.md, docs/architecture/编码规范.md]

**缓存策略优化:**
```java
// 使用Caffeine缓存提升性能
@Bean
public TokenRegistry cachingTokenRegistry() {
    return new CachingTokenRegistry(
        Caffeine.newBuilder()
            .maximumSize(10000)           // 最大缓存10000个Token
            .expireAfterWrite(Duration.ofHours(2))  // 2小时后过期
            .build()
    );
}
```

**Redis连接池优化:**
```yaml
spring:
  data:
    redis:
      lettuce:
        pool:
          max-active: 20    # 最大连接数
          max-idle: 10      # 最大空闲连接
          min-idle: 5       # 最小空闲连接
          max-wait: 2000    # 最大等待时间(ms)
```

**JVM参数优化建议:**
```bash
-Xmx2g -Xms2g              # 堆内存2GB
-XX:+UseG1GC               # 使用G1垃圾收集器
-XX:MaxGCPauseMillis=200   # 最大GC暂停时间200ms
```

**嵌入式服务器选择:**
- **Tomcat**: Spring Boot默认,成熟稳定,通用场景
- **Undertow**: 轻量级,高性能,内存占用约为Tomcat的70%,适用于高并发场景

### 监控和健康检查信息

[Source: docs/architecture/tech-stack.md#8-性能和监控]

**Spring Boot Actuator集成:**
```xml
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-actuator</artifactId>
</dependency>
```

**监控组件(可选):**
- **Micrometer**: 指标收集(内置于Actuator)
- **Prometheus**: 指标存储(需额外依赖`micrometer-registry-prometheus`)
- **Grafana**: 指标可视化(外部工具)

**健康检查端点:**
```yaml
management:
  endpoints:
    web:
      exposure:
        include: health,info,metrics  # 暴露健康检查端点
  endpoint:
    health:
      show-details: when-authorized   # 授权后显示详细信息
```

**关键监控指标:**
- Token数量: `sessionCount()`
- Token过期率: 过期Token数 / 总Token数
- Redis连接池状态: 活跃连接数、空闲连接数
- JVM内存使用率

### 故障排查常见问题

[Source: 基于架构文档和实际经验总结]

**常见问题场景:**

1. **Token认证失败(401错误)**
   - 原因: Token不存在、已过期、格式错误
   - 解决: 检查Token是否正确传递(Header/Cookie/Parameter)

2. **Redis连接失败**
   - 原因: Redis未启动、网络不通、密码错误
   - 解决: 检查Redis配置、网络连接、认证信息

3. **自动配置未生效**
   - 原因: 配置条件不满足、Bean冲突
   - 解决: 检查配置项、查看自动配置报告(`--debug`)

4. **Token过期处理**
   - 原因: 过期时间设置不合理、时区问题
   - 解决: 检查`timeToKillInSeconds`配置、验证服务器时区

### 文档结构和格式

[Source: docs/architecture/编码规范.md#6-文档规范]

**文档编写规范:**
- 使用Markdown格式
- 使用中文编写,保持术语一致性
- 代码示例包含完整的import语句
- 配置示例使用YAML格式
- 所有示例代码必须经过验证

**代码示例要求:**
- 包含package声明
- 包含完整import语句
- 包含异常处理
- 包含JavaDoc注释
- 遵循SOLID原则

**文档术语一致性:**
- Token (令牌)
- TokenRegistry (Token注册表)
- ExpirationPolicy (过期策略)
- TimeoutAccessToken (自动续期访问令牌)
- HardTimeoutToken (固定时间令牌)

### 项目技术栈信息

[Source: docs/architecture/tech-stack.md]

**核心技术:**
- Java 17
- Spring Boot 3.5.6
- Spring Security 6.x
- Spring Data Redis 3.x
- Maven 3.x

**工具库:**
- Caffeine - 高性能本地缓存
- Lombok - 代码简化
- Commons Lang3 - 工具类
- Jackson - JSON序列化

### 文档位置信息

[Source: docs/architecture/source-tree.md]

**文档应该创建的位置:**
- 集成指南: `docs/integration.md`
- 最佳实践文档: `docs/best-practices.md`
- 文档索引更新: `docs/README.md`

### 扩展点信息

[Source: docs/architecture/8-扩展点.md]

**自定义Security配置示例:**
```java
@Configuration
@EnableWebSecurity
public class CustomSecurityConfig extends TokenSecurityConfig {

    @Override
    protected String[] getPermitAntMatchers() {
        return new String[]{"/public/**", "/login", "/health"};
    }

    @Override
    protected String[] getAuthenticatedAntMatchers() {
        return new String[]{"/api/**", "/admin/**"};
    }
}
```

**自定义Token清理策略示例:**
```java
@Component
public class CustomTokenRegistryCleaner implements TokenRegistryCleaner {

    @Override
    @Scheduled(cron = "0 */10 * * * *")  // 每10分钟执行一次
    public void clean() {
        // 批量清理过期Token
    }
}
```

### 设计原则应用

**KISS原则:**
- 集成指南结构简洁明了,步骤清晰
- 最佳实践文档聚焦常见问题和解决方案

**YAGNI原则:**
- 只包含当前版本实际支持的集成方式和配置
- 避免提及未实现的特性或计划中的功能

**DRY原则:**
- 引用已有的架构文档和配置参考,避免重复
- 使用链接指向详细文档

### Testing

本Story为文档创建任务,主要验证方式为:

**文档质量验证(手动验证):**
- 按照集成指南实际操作验证可行性
- 验证最佳实践建议基于实际代码能力
- 验证故障排查指南覆盖常见问题
- 验证所有配置示例和代码片段正确性

**集成验证(Integration Validation):**
- IV1: 集成指南能够指导真实的系统集成
- IV2: 最佳实践建议基于实际代码能力和限制
- IV3: 故障排查指南覆盖常见问题

**无需编写单元测试或集成测试(文档任务)**

**验证方法:**
1. 集成指南验证: 按照步骤在全新环境中实际操作
2. 最佳实践验证: 对照架构文档和源码确认建议可行性
3. 配置示例验证: 将配置示例应用到测试项目中验证
4. 代码片段验证: 将代码片段提取到测试项目中编译验证

## Dev Agent Record

### Agent Model Used
(待Dev Agent填写)

### Debug Log References
(待Dev Agent填写)

### Completion Notes
(待Dev Agent填写)

### File List
(待Dev Agent填写)

## QA Results
(待QA Agent填写)

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-12 | 1.0 | 初始故事创建 | Bob (Scrum Master) |
