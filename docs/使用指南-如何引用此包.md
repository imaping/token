# 如何在其他项目中使用 imaping-token

本文档详细说明如何在你的项目中引用发布到 GitHub Packages 的 `imaping-token` 包。

## 前置条件

- 拥有 GitHub 账号
- 安装了 Maven 3.x
- JDK 17 或更高版本

## 步骤 1: 创建 GitHub Personal Access Token (PAT)

### 1.1 生成 Token

1. 访问 GitHub Settings: https://github.com/settings/tokens
2. 点击 **"Generate new token"** → **"Generate new token (classic)"**
3. 设置 Token 名称,例如: `maven-github-packages`
4. 勾选以下权限:
   - ✅ `read:packages` (读取包)
5. 点击 **"Generate token"**
6. **重要**: 立即复制并保存这个 token,离开页面后将无法再次查看

### 1.2 Token 示例

```
ghp_xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
```

## 步骤 2: 配置 Maven Settings

### 2.1 找到 settings.xml 文件

Maven 配置文件位置:
- **Windows**: `C:\Users\你的用户名\.m2\settings.xml`
- **Linux/Mac**: `~/.m2/settings.xml`

如果文件不存在,需要创建它。

### 2.2 编辑 settings.xml

在 `settings.xml` 中添加服务器认证配置:

```xml
<?xml version="1.0" encoding="UTF-8"?>
<settings xmlns="http://maven.apache.org/SETTINGS/1.0.0"
          xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
          xsi:schemaLocation="http://maven.apache.org/SETTINGS/1.0.0
          http://maven.apache.org/xsd/settings-1.0.0.xsd">

    <servers>
        <server>
            <id>github</id>
            <username>你的GitHub用户名</username>
            <password>你的GitHub_PAT_Token</password>
        </server>
    </servers>

</settings>
```

**示例**:
```xml
<servers>
    <server>
        <id>github</id>
        <username>zhangsan</username>
        <password>ghp_xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx</password>
    </server>
</servers>
```

⚠️ **安全提示**: 不要将 settings.xml 提交到版本控制系统!

## 步骤 3: 在项目中配置仓库

在你的项目 `pom.xml` 中添加 GitHub Packages 仓库配置:

```xml
<project>
    <!-- 其他配置 -->

    <repositories>
        <repository>
            <id>github</id>
            <name>GitHub Packages</name>
            <url>https://maven.pkg.github.com/你的用户名/仓库名</url>
            <releases>
                <enabled>true</enabled>
            </releases>
            <snapshots>
                <enabled>true</enabled>
            </snapshots>
        </repository>
    </repositories>

</project>
```

**示例** (假设仓库是 `zhangsan/imaping-token`):
```xml
<repositories>
    <repository>
        <id>github</id>
        <url>https://maven.pkg.github.com/zhangsan/imaping-token</url>
    </repository>
</repositories>
```

## 步骤 4: 添加依赖

在 `pom.xml` 的 `<dependencies>` 部分添加需要的模块:

### 核心模块

```xml
<dependency>
    <groupId>com.imaping</groupId>
    <artifactId>imaping-token-core</artifactId>
    <version>1.0.0</version>
</dependency>
```

### API 模块

```xml
<dependency>
    <groupId>com.imaping</groupId>
    <artifactId>imaping-token-api</artifactId>
    <version>1.0.0</version>
</dependency>
```

### Redis 注册实现

```xml
<dependency>
    <groupId>com.imaping</groupId>
    <artifactId>imaping-token-redis-registry</artifactId>
    <version>1.0.0</version>
</dependency>
```

### 资源客户端

```xml
<dependency>
    <groupId>com.imaping</groupId>
    <artifactId>imaping-token-resource-client</artifactId>
    <version>1.0.0</version>
</dependency>
```

### 配置模型

```xml
<dependency>
    <groupId>com.imaping</groupId>
    <artifactId>imaping-token-configuration-model</artifactId>
    <version>1.0.0</version>
</dependency>
```

## 步骤 5: 验证配置

运行以下命令验证依赖是否能正确下载:

```bash
mvn dependency:resolve
```

如果配置正确,你应该能看到类似输出:
```
[INFO] Downloaded from github: https://maven.pkg.github.com/.../imaping-token-core/1.0.0/imaping-token-core-1.0.0.jar
[INFO] BUILD SUCCESS
```

## 完整示例

这是一个完整的 `pom.xml` 示例:

```xml
<?xml version="1.0" encoding="UTF-8"?>
<project xmlns="http://maven.apache.org/POM/4.0.0"
         xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0
         http://maven.apache.org/xsd/maven-4.0.0.xsd">
    <modelVersion>4.0.0</modelVersion>

    <groupId>com.example</groupId>
    <artifactId>my-project</artifactId>
    <version>1.0.0</version>

    <properties>
        <java.version>17</java.version>
        <imaping.token.version>1.0.0</imaping.token.version>
    </properties>

    <repositories>
        <repository>
            <id>github</id>
            <url>https://maven.pkg.github.com/你的用户名/imaping-token</url>
            <releases>
                <enabled>true</enabled>
            </releases>
            <snapshots>
                <enabled>true</enabled>
            </snapshots>
        </repository>
    </repositories>

    <dependencies>
        <!-- imaping-token 核心功能 -->
        <dependency>
            <groupId>com.imaping</groupId>
            <artifactId>imaping-token-core</artifactId>
            <version>${imaping.token.version}</version>
        </dependency>

        <!-- imaping-token API -->
        <dependency>
            <groupId>com.imaping</groupId>
            <artifactId>imaping-token-api</artifactId>
            <version>${imaping.token.version}</version>
        </dependency>

        <!-- Redis 注册实现(可选) -->
        <dependency>
            <groupId>com.imaping</groupId>
            <artifactId>imaping-token-redis-registry</artifactId>
            <version>${imaping.token.version}</version>
        </dependency>
    </dependencies>

</project>
```

## 版本选择

### SNAPSHOT 版本

用于开发和测试:
```xml
<version>0.0.1-SNAPSHOT</version>
```

**特点**:
- 自动获取最新开发版本
- 可能不稳定
- Maven 会定期检查更新

### 正式版本

用于生产环境:
```xml
<version>1.0.0</version>
```

**特点**:
- 稳定版本
- 不会自动更新
- 推荐用于生产

## 常见问题

### ❌ 401 Unauthorized

**原因**: 认证失败

**解决方案**:
1. 检查 `settings.xml` 中的用户名和 token 是否正确
2. 确认 token 具有 `read:packages` 权限
3. 检查 token 是否已过期

### ❌ 404 Not Found

**原因**: 仓库地址错误或包未发布

**解决方案**:
1. 确认仓库 URL 格式: `https://maven.pkg.github.com/用户名/仓库名`
2. 检查包是否已成功发布到 GitHub Packages
3. 访问 `https://github.com/用户名/仓库名/packages` 查看可用的包

### ❌ Could not transfer artifact

**原因**: 网络问题或代理配置

**解决方案**:
1. 检查网络连接
2. 如果使用代理,在 `settings.xml` 中配置代理
3. 尝试添加 `-U` 参数强制更新: `mvn clean install -U`

### ❌ SNAPSHOT 版本不更新

**解决方案**:
```bash
# 强制更新 SNAPSHOT 版本
mvn clean install -U

# 或清理本地仓库缓存
rm -rf ~/.m2/repository/com/imaping/imaping-token-*
```

## 在不同环境中使用

### CI/CD 环境 (如 GitHub Actions)

在 CI/CD 中,可以使用环境变量配置:

```yaml
- name: Configure Maven
  uses: s4u/maven-settings-action@v3
  with:
    servers: |
      [{
        "id": "github",
        "username": "${{ github.actor }}",
        "password": "${{ secrets.GITHUB_TOKEN }}"
      }]

- name: Build
  run: mvn clean install
```

### Docker 环境

在 Dockerfile 中配置:

```dockerfile
FROM maven:3.9-eclipse-temurin-17

# 复制 settings.xml
COPY settings.xml /root/.m2/settings.xml

# 复制项目文件
COPY pom.xml .
COPY src ./src

# 构建
RUN mvn clean package
```

## 安全最佳实践

1. **不要硬编码 Token**
   - ❌ 不要将 token 写在 `pom.xml` 中
   - ✅ 使用 `settings.xml` 或环境变量

2. **Token 权限最小化**
   - 只授予必要的权限 (`read:packages`)
   - 定期轮换 token

3. **保护 settings.xml**
   - 不要提交到版本控制
   - 设置适当的文件权限

4. **使用版本范围**
   - 避免使用 `LATEST` 或 `RELEASE`
   - 明确指定版本号

## 获取帮助

如果遇到问题:

1. **查看文档**: [GitHub Packages 使用配置](./github-packages-setup.md)
2. **检查日志**: 使用 `mvn -X` 查看详细日志
3. **查看包列表**: 访问仓库的 Packages 页面
4. **联系维护者**: 在仓库中创建 Issue

## 相关文档

- [GitHub Packages 配置](./github-packages-setup.md)
- [快速开始](./quick-start.md)
- [API 指南](./api-guide.md)
- [配置说明](./configuration.md)

## 总结

引用 GitHub Packages 的关键步骤:

1. ✅ 创建 GitHub PAT (带 `read:packages` 权限)
2. ✅ 配置 `~/.m2/settings.xml` 添加认证信息
3. ✅ 在项目 `pom.xml` 中添加仓库配置
4. ✅ 添加依赖声明
5. ✅ 运行 `mvn dependency:resolve` 验证

完成这些步骤后,就可以像使用 Maven Central 一样使用 imaping-token 了!
