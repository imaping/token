# 6. 部署架构

### 6.1 单机部署

```
┌─────────────────────────────────────────────────────┐
│                   Spring Boot 应用                   │
├─────────────────────────────────────────────────────┤
│                                                     │
│  ┌─────────────────────────────────────────────┐   │
│  │       TokenRegistry (内存)                  │   │
│  │  - DefaultTokenRegistry                     │   │
│  │  - 存储: ConcurrentHashMap                  │   │
│  └─────────────────────────────────────────────┘   │
│                                                     │
│  ┌─────────────────────────────────────────────┐   │
│  │       TokenAuthenticationFilter             │   │
│  │  - Token 提取和验证                          │   │
│  └─────────────────────────────────────────────┘   │
│                                                     │
│  ┌─────────────────────────────────────────────┐   │
│  │       TokenSchedulingConfiguration          │   │
│  │  - 定时清理过期 Token                        │   │
│  └─────────────────────────────────────────────┘   │
│                                                     │
└─────────────────────────────────────────────────────┘
                         │
                         │ HTTP Request
                         ▼
                    ┌─────────┐
                    │ 用户请求 │
                    └─────────┘
```

**配置示例**:
```yaml
imaping:
  token:
    accessTokenName: access_token
    registry:
      redis:
        enabled: false            # 使用内存存储
      inMemory:
        cache: true               # 启用 Caffeine 缓存
        initialCapacity: 1000
        loadFactor: 1
        concurrency: 20
    accessToken:
      timeToKillInSeconds: 7200   # 2小时
    scheduling:
      enabled: true
      repeatInterval: 120000      # 2分钟清理一次
```

**适用场景**:
- 低并发应用
- 开发/测试环境
- 不需要跨实例共享会话

### 6.2 分布式部署 (Redis)

```
┌──────────────────┐     ┌──────────────────┐     ┌──────────────────┐
│  Spring Boot 实例1│     │  Spring Boot 实例2│     │  Spring Boot 实例N│
├──────────────────┤     ├──────────────────┤     ├──────────────────┤
│ RedisTokenRegistry│     │ RedisTokenRegistry│     │ RedisTokenRegistry│
└────────┬─────────┘     └────────┬─────────┘     └────────┬─────────┘
         │                        │                        │
         └────────────────────────┼────────────────────────┘
                                  │
                                  ▼
                      ┌───────────────────────┐
                      │      Redis 集群        │
                      ├───────────────────────┤
                      │  Key 格式:             │
                      │  imaping.token:        │
                      │    {tokenId}:{userId}  │
                      │                       │
                      │  TTL 自动过期          │
                      └───────────────────────┘
                                  │
                                  │
                      ┌───────────▼───────────┐
                      │    负载均衡器 (Nginx)   │
                      └───────────┬───────────┘
                                  │ HTTP Request
                                  ▼
                              ┌─────────┐
                              │ 用户请求 │
                              └─────────┘
```

**配置示例**:
```yaml
imaping:
  token:
    accessTokenName: access_token
    registry:
      redis:
        enabled: true             # 使用 Redis 存储
      core:
        enable-locking: true      # 启用分布式锁
    accessToken:
      timeToKillInSeconds: 7200   # 2小时
    scheduling:
      enabled: false              # Redis 自动过期,无需定时清理

spring:
  data:
    redis:
      host: redis-cluster.example.com
      port: 6379
      password: ${REDIS_PASSWORD}
      database: 0
      lettuce:
        pool:
          max-active: 20
          max-idle: 10
          min-idle: 5
```

**适用场景**:
- 高并发应用
- 多实例集群部署
- 需要跨实例共享会话
- 需要持久化 Token

**优势**:
- ✅ 集群共享: 所有实例共享同一份 Token 数据
- ✅ 持久化: Redis 持久化机制保证数据不丢失
- ✅ 自动过期: Redis TTL 自动清理过期 Token
- ✅ 高可用: Redis 集群支持主从复制和哨兵

### 6.3 网络拓扑

```
                          Internet
                             │
                             ▼
                    ┌────────────────┐
                    │   负载均衡器    │
                    │   (Nginx/ALB)  │
                    └────────┬───────┘
                             │
              ┌──────────────┼──────────────┐
              │              │              │
              ▼              ▼              ▼
       ┌──────────┐   ┌──────────┐   ┌──────────┐
       │ App 实例1 │   │ App 实例2 │   │ App 实例N │
       └─────┬────┘   └─────┬────┘   └─────┬────┘
             │              │              │
             └──────────────┼──────────────┘
                            │
                   ┌────────▼────────┐
                   │   Redis 集群     │
                   │  (主从/哨兵)     │
                   └─────────────────┘
```

---
