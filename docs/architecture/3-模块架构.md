# 3. 模块架构

### 3.1 模块依赖图

```
imaping-token-parent (父POM)
│
├── imaping-token-dependencies (依赖管理)
│   └── [管理所有模块版本]
│
├── imaping-configuration-model (配置模型)
│   └── [定义配置属性]
│
├── imaping-token-core (核心模型)
│   └── [用户上下文和安全上下文]
│
├── imaping-token-api (核心API)
│   ├── ← imaping-token-core
│   ├── ← imaping-configuration-model
│   └── [Token管理核心逻辑]
│
├── imaping-token-redis-registry (Redis实现)
│   ├── ← imaping-token-api
│   └── [Redis存储实现]
│
└── imaping-token-resource-client (资源客户端)
    ├── ← imaping-token-api
    └── [Spring Security集成]
```

### 3.2 模块职责

#### 3.2.1 imaping-token-dependencies

**职责**: 依赖版本统一管理

**关键文件**:
- [pom.xml](imaping-token-dependencies/pom.xml)

**提供内容**:
- 继承 `spring-boot-dependencies:3.5.6`
- 定义所有子模块版本 (通过 `${revision}` 变量)

**依赖关系**:
```
└── spring-boot-dependencies:3.5.6
```

#### 3.2.2 imaping-configuration-model

**职责**: 配置属性模型定义

**核心类**:
- [`IMapingConfigurationProperties`](imaping-configuration-model/src/main/java/com/imaping/token/configuration/IMapingConfigurationProperties.java) - 主配置类 (@ConfigurationProperties("imaping"))
- [`TokenConfigurationProperties`](imaping-configuration-model/src/main/java/com/imaping/token/configuration/model/token/TokenConfigurationProperties.java) - Token 配置
- [`TokenRegistryProperties`](imaping-configuration-model/src/main/java/com/imaping/token/configuration/model/token/TokenRegistryProperties.java) - 注册表配置
- [`AccessTokenProperties`](imaping-configuration-model/src/main/java/com/imaping/token/configuration/model/token/AccessTokenProperties.java) - 访问令牌配置

**自动配置**:
- `IMapingPropertiesConfiguration`

**依赖关系**:
```
├── spring-boot
├── spring-boot-configuration-processor
└── jackson-annotations
```

#### 3.2.3 imaping-token-core

**职责**: 用户信息和安全上下文管理

**核心类**:
```
com.imaping.token.core.model
├── UserInfo (接口) - 用户信息基础接口
├── BaseUserInfo - 基础用户信息实体
├── SecurityUserInfo - 安全用户信息实体
├── UserInfoContext (接口) - 用户信息上下文
├── DefaultUserInfoContext - 默认实现
├── SecurityUserInfoContext (接口) - 安全用户信息上下文
└── DefaultSecurityUserInfoContext - 默认实现
```

**工具类**:
- [`SecurityContextUtil`](imaping-token-core/src/main/java/com/imaping/token/core/util/SecurityContextUtil.java:1) - 安全上下文工具

**自动配置**:
- [`TokenCoreAutoConfig`](imaping-token-core/src/main/java/com/imaping/token/core/TokenCoreAutoConfig.java:1)

**依赖关系**:
```
├── spring-boot
├── spring-security-web
└── jackson-annotations
```

#### 3.2.4 imaping-token-api

**职责**: Token 管理核心 API 和实现

**核心包结构**:
```
com.imaping.token.api
├── model/             # Token 模型
├── registry/          # Token 注册表
├── factory/           # Token 工厂
├── expiration/        # 过期策略
├── authentication/    # 认证组件
├── generator/         # ID 生成器
├── lock/              # 锁管理
├── exception/         # 异常处理
├── config/            # 自动配置
└── common/            # 工具类
```

**自动配置**:
- [`TokenApiConfig`](imaping-token-api/src/main/java/com/imaping/token/api/config/TokenApiConfig.java:1) - 核心配置类
- [`TokenSchedulingConfiguration`](imaping-token-api/src/main/java/com/imaping/token/api/config/TokenSchedulingConfiguration.java:1) - 调度配置

**依赖关系**:
```
├── imaping-token-core
├── imaping-configuration-model
├── jackson (datatype-jsr310, core, annotations)
├── caffeine
├── commons-io:2.11.0
├── commons-lang3
├── commons-codec
├── spring-tx
└── spring-integration-core
```

#### 3.2.5 imaping-token-redis-registry

**职责**: 基于 Redis 的 Token 存储实现

**核心类**:
- [`RedisTokenRegistry`](imaping-token-redis-registry/src/main/java/com/imaping/token/redis/registry/RedisTokenRegistry.java:1) - Redis 注册表实现
- [`TokenRedisTemplate`](imaping-token-redis-registry/src/main/java/com/imaping/token/redis/registry/TokenRedisTemplate.java:1) - Redis 模板接口
- [`DefaultTokenRedisTemplate`](imaping-token-redis-registry/src/main/java/com/imaping/token/redis/registry/DefaultTokenRedisTemplate.java:1) - 默认实现

**自动配置**:
- [`TokenConfig`](imaping-token-redis-registry/src/main/java/com/imaping/token/redis/registry/config/TokenConfig.java:1)

**条件激活**:
```yaml
imaping.token.registry.redis.enabled: true
```

**Redis Key 格式**:
```
imaping.token:{tokenId}:{userId}
```

**依赖关系**:
```
├── imaping-token-api
└── spring-boot-starter-data-redis
```

#### 3.2.6 imaping-token-resource-client

**职责**: Spring Security 集成和 Token 认证

**核心类**:
```
com.imaping.token.resource.client
├── authentication/
│   ├── TokenAuthenticationProvider - 认证提供者
│   └── TokenAuthenticationEntryPoint - 认证入口点
├── filter/
│   └── TokenAuthenticationFilter - Token 认证过滤器
├── aware/
│   └── CurrentUserAutoAware - 当前用户自动注入
└── config/
    ├── ResourceClientConfig - 资源客户端配置
    └── TokenSecurityConfig - Security 配置
```

**自动配置**:
- [`ResourceClientConfig`](imaping-token-resource-client/src/main/java/com/imaping/token/resource/client/config/ResourceClientConfig.java:1)
- [`TokenSecurityConfig`](imaping-token-resource-client/src/main/java/com/imaping/token/resource/client/config/TokenSecurityConfig.java:1)

**依赖关系**:
```
├── imaping-token-api
├── spring-security-web
├── spring-security-config
└── jakarta.servlet-api:6.0.0 (provided)
```

### 3.3 编译顺序

Maven Reactor 构建顺序:
```
1. imaping-token-dependencies
2. imaping-configuration-model
3. imaping-token-core
4. imaping-token-api
5. imaping-token-redis-registry
6. imaping-token-resource-client
```

---
