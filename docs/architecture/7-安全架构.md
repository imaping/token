# 7. 安全架构

### 7.1 安全组件

```
┌─────────────────────────────────────────────────────┐
│               Spring Security 集成                   │
├─────────────────────────────────────────────────────┤
│                                                     │
│  TokenSecurityConfig                                │
│  ├── SecurityFilterChain                            │
│  │   ├── permitAll: /public/**, /health            │
│  │   ├── authenticated: /api/**, /admin/**         │
│  │   └── csrf: disabled (可配置)                   │
│  │                                                  │
│  ├── TokenAuthenticationFilter                      │
│  │   ├── 提取 Token (Header/Cookie/Parameter)       │
│  │   ├── 验证 Token                                 │
│  │   └── 设置 SecurityContext                       │
│  │                                                  │
│  ├── TokenAuthenticationProvider                    │
│  │   ├── 从 TokenRegistry 获取 Token               │
│  │   ├── 验证过期状态                               │
│  │   └── 返回 Authentication                        │
│  │                                                  │
│  └── TokenAuthenticationEntryPoint                  │
│      └── 返回 401 Unauthorized                      │
│                                                     │
└─────────────────────────────────────────────────────┘
```

### 7.2 Token 提取策略

**优先级顺序**:
1. **HTTP Header** (最高优先级)
   ```
   Authorization: Bearer <token>
   ```

2. **Cookie**
   ```
   Cookie: access_token=<token>
   ```

3. **Request Parameter** (最低优先级)
   ```
   GET /api/users?access_token=<token>
   ```

**关键源文件**: [`TokenAuthenticationFilter`](imaping-token-resource-client/src/main/java/com/imaping/token/resource/client/filter/TokenAuthenticationFilter.java:1)

### 7.3 Token 失效处理

```
Token 验证失败
     │
     ├─ Token 不存在
     │   └─ 返回 401 Unauthorized
     │
     ├─ Token 已过期
     │   ├─ 删除 Token (从 TokenRegistry)
     │   ├─ 清除 Cookie (如果是从 Cookie 提取)
     │   └─ 返回 401 Unauthorized
     │
     └─ Token 格式错误
         └─ 返回 401 Unauthorized
```

**关键代码路径**:
- 验证逻辑: [`TokenAuthenticationProvider.authenticate()`](imaping-token-resource-client/src/main/java/com/imaping/token/resource/client/authentication/TokenAuthenticationProvider.java:1)
- 入口点: [`TokenAuthenticationEntryPoint.commence()`](imaping-token-resource-client/src/main/java/com/imaping/token/resource/client/authentication/TokenAuthenticationEntryPoint.java:1)

### 7.4 安全最佳实践

#### 7.4.1 Token 长度和强度

```java
// 默认配置
UniqueTokenIdGenerator tokenIdGenerator = new DefaultUniqueTokenIdGenerator(
    new Base64RandomStringGenerator(),
    32  // 32字符长度 (256位熵)
);
```

**建议**:
- ✅ Token 长度 ≥ 32 字符
- ✅ 使用 Base64 编码随机字节
- ✅ 避免使用可预测的 ID 生成算法

#### 7.4.2 过期时间配置

```yaml
imaping:
  token:
    accessToken:
      timeToKillInSeconds: 7200  # 2小时 (生产环境建议值)
```

**建议**:
- ✅ 短期 Token: 1-4 小时
- ✅ 长期 Token: 使用 Refresh Token 机制 (需自行实现)
- ❌ 避免: 无限期 Token

#### 7.4.3 HTTPS 传输

```yaml
server:
  ssl:
    enabled: true
    key-store: classpath:keystore.p12
    key-store-password: ${SSL_KEY_PASSWORD}
    key-store-type: PKCS12
```

**建议**:
- ✅ 生产环境强制使用 HTTPS
- ✅ 设置 Cookie 的 `Secure` 属性
- ✅ 设置 Cookie 的 `HttpOnly` 属性

#### 7.4.4 CSRF 保护

```java
@Bean
public SecurityFilterChain filterChain(HttpSecurity http) throws Exception {
    http
        .csrf(csrf -> csrf
            .csrfTokenRepository(CookieCsrfTokenRepository.withHttpOnlyFalse())
        );
    return http.build();
}
```

**建议**:
- ✅ 对于传统表单应用,启用 CSRF 保护
- ✅ 对于 RESTful API (Bearer Token),可禁用 CSRF
- ✅ 使用 `SameSite=Strict` Cookie 属性

---
