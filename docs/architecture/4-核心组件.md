# 4. 核心组件

### 4.1 Token 类型层次结构

```
Token (接口)
├── getId(): String                    # Token ID
├── getCreationTime(): ZonedDateTime  # 创建时间
├── getCountOfUses(): int             # 使用次数
├── isExpired(): Boolean              # 是否过期
├── getExpirationPolicy()             # 过期策略
├── markTokenExpired(): void          # 标记过期
└── update(): void                    # 更新使用状态
     │
     └─── AbstractToken (抽象类)
          ├── id: String
          ├── expirationPolicy: ExpirationPolicy
          ├── lastTimeUsed: ZonedDateTime
          ├── previousTimeUsed: ZonedDateTime
          ├── creationTime: ZonedDateTime
          ├── countOfUses: int
          ├── expired: Boolean
          └── authentication: Authentication
               │
               ├─── TimeoutAccessToken (接口)
               │    └── DefaultTimeoutAccessToken
               │         ├── PREFIX = "AT"
               │         ├── 过期策略: TimeoutExpirationPolicy
               │         └── 用途: 自动续期的访问令牌
               │
               └─── HardTimeoutToken (接口)
                    └── DefaultHardTimeoutToken
                         ├── PREFIX = "ATT"
                         ├── code: String (业务编码)
                         ├── description: String (描述)
                         ├── 过期策略: HardTimeoutExpirationPolicy
                         └── 用途: 固定时间令牌(验证码、临时链接)
```

**关键源文件**:
- [`Token`](imaping-token-api/src/main/java/com/imaping/token/api/model/Token.java:1)
- [`AbstractToken`](imaping-token-api/src/main/java/com/imaping/token/api/model/AbstractToken.java:1)
- [`DefaultTimeoutAccessToken`](imaping-token-api/src/main/java/com/imaping/token/api/model/DefaultTimeoutAccessToken.java:1)
- [`DefaultHardTimeoutToken`](imaping-token-api/src/main/java/com/imaping/token/api/model/DefaultHardTimeoutToken.java:1)

### 4.2 ExpirationPolicy 过期策略

```
ExpirationPolicy (接口)
├── isExpired(Token): Boolean     # 判断是否过期
├── getTimeToLive(): Long         # 获取存活时间(TTL)
└── getTimeToIdle(): Long         # 获取空闲时间
     │
     └─── AbstractTokenExpirationPolicy (抽象类)
          │
          ├─── TimeoutExpirationPolicy
          │    ├── 判断逻辑: lastTimeUsed + timeToIdle < now
          │    ├── 特性: 每次使用自动续期
          │    └── 适用场景: 需要保持活跃的会话 Token
          │
          └─── HardTimeoutExpirationPolicy
               ├── 判断逻辑: creationTime + timeToLive < now
               ├── 特性: 固定时间后失效,不受使用影响
               └── 适用场景: 验证码、临时授权链接
```

**构建器模式**:
```
ExpirationPolicyBuilder (接口)
├── TimeoutExpirationPolicyBuilder
│   └── 构建 TimeoutExpirationPolicy
│
├── HardTimeoutExpirationPolicyBuilder
│   └── 构建 HardTimeoutExpirationPolicy
│
└── HardTimeoutExpirationPolicyDefaultBuilder
    └── 构建默认 HardTimeoutExpirationPolicy
```

**关键源文件**:
- [`ExpirationPolicy`](imaping-token-api/src/main/java/com/imaping/token/api/expiration/ExpirationPolicy.java:1)
- [`TimeoutExpirationPolicy`](imaping-token-api/src/main/java/com/imaping/token/api/expiration/TimeoutExpirationPolicy.java:1)
- [`HardTimeoutExpirationPolicy`](imaping-token-api/src/main/java/com/imaping/token/api/expiration/HardTimeoutExpirationPolicy.java:1)

### 4.3 TokenRegistry 注册表

```
TokenRegistry (接口)
├── addToken(Token): Token                     # 添加 Token
├── getToken(String): Token                    # 获取 Token
├── getToken(String, Class<T>): T             # 按类型获取
├── deleteToken(String): Token                 # 删除 Token
├── updateToken(Token): void                   # 更新 Token
├── getTokens(): Collection<Token>             # 获取所有 Token
├── sessionCount(): long                       # 会话计数
├── countSessionsFor(String): long             # 统计用户会话数
└── getSessionsFor(String): Collection<Token>  # 获取用户会话
     │
     └─── AbstractTokenRegistry (抽象类)
          ├── 封装通用逻辑
          └── 定义抽象方法
               │
               ├─── AbstractMapBasedTokenRegistry
               │    ├── 基于 Map 的抽象实现
               │    └── DefaultTokenRegistry
               │         ├── 存储: ConcurrentHashMap
               │         ├── 场景: 单机应用
               │         └── 特性: 快速、无持久化
               │
               ├─── CachingTokenRegistry
               │    ├── 存储: Caffeine 缓存
               │    ├── 场景: 单机应用
               │    └── 特性: 带缓存优化
               │
               └─── RedisTokenRegistry
                    ├── 存储: Redis
                    ├── 场景: 分布式应用
                    └── 特性: 持久化、集群共享、TTL 自动过期
```

**对比表**:

| 实现类 | 存储方式 | 适用场景 | 持久化 | 集群支持 | TTL 自动过期 |
|--------|----------|----------|--------|----------|-------------|
| DefaultTokenRegistry | ConcurrentHashMap | 单机应用 | ❌ | ❌ | ❌ |
| CachingTokenRegistry | Caffeine 缓存 | 单机应用 | ❌ | ❌ | ✅ |
| RedisTokenRegistry | Redis | 分布式应用 | ✅ | ✅ | ✅ |

**关键源文件**:
- [`TokenRegistry`](imaping-token-api/src/main/java/com/imaping/token/api/registry/TokenRegistry.java:1)
- [`DefaultTokenRegistry`](imaping-token-api/src/main/java/com/imaping/token/api/registry/DefaultTokenRegistry.java:1)
- [`RedisTokenRegistry`](imaping-token-redis-registry/src/main/java/com/imaping/token/redis/registry/RedisTokenRegistry.java:1)

### 4.4 TokenFactory 工厂

```
TokenFactory (接口)
├── getTokenType(): Class<? extends Token>           # 获取 Token 类型
├── createToken(Authentication): Token               # 创建 Token
└── createToken(String, Authentication): Token       # 创建指定 ID 的 Token
     │
     ├─── DefaultTokenFactory
     │    ├── 组合工厂
     │    ├── 支持多种 Token 类型
     │    └── 根据类型委托给具体工厂
     │
     ├─── TimeoutTokenFactory (接口)
     │    └── TimeoutTokenDefaultFactory
     │         └── 创建 DefaultTimeoutAccessToken
     │
     └─── HardTimeoutTokenFactory (接口)
          └── HardTimeoutTokenDefaultFactory
               └── 创建 DefaultHardTimeoutToken
```

**关键源文件**:
- [`TokenFactory`](imaping-token-api/src/main/java/com/imaping/token/api/factory/TokenFactory.java:1)
- [`DefaultTokenFactory`](imaping-token-api/src/main/java/com/imaping/token/api/factory/DefaultTokenFactory.java:1)
- [`TimeoutTokenDefaultFactory`](imaping-token-api/src/main/java/com/imaping/token/api/factory/TimeoutTokenDefaultFactory.java:1)
- [`HardTimeoutTokenDefaultFactory`](imaping-token-api/src/main/java/com/imaping/token/api/factory/HardTimeoutTokenDefaultFactory.java:1)

### 4.5 Authentication 认证机制

```
Authentication (类)
├── principal: Principal              # 主体
│   ├── id: String                   # 用户 ID
│   └── userInfo: BaseUserInfo       # 用户详细信息
│        ├── userId: Long
│        ├── username: String
│        ├── nickname: String
│        ├── email: String
│        ├── mobile: String
│        └── ...
└── attributes: Map<String, Object>   # 附加属性
```

**相关类**:
- [`Authentication`](imaping-token-api/src/main/java/com/imaping/token/api/authentication/Authentication.java:1)
- [`Principal`](imaping-token-api/src/main/java/com/imaping/token/api/authentication/principal/Principal.java:1)
- [`BaseUserInfo`](imaping-token-core/src/main/java/com/imaping/token/core/model/BaseUserInfo.java:1)
- [`DefaultTokenAuthentication`](imaping-token-api/src/main/java/com/imaping/token/api/authentication/DefaultTokenAuthentication.java:1)
- [`DefaultBearerTokenAuthenticationToken`](imaping-token-api/src/main/java/com/imaping/token/api/authentication/DefaultBearerTokenAuthenticationToken.java:1)

### 4.6 ID 生成器

```
UniqueTokenIdGenerator (接口)
└── getNewTokenId(int length): String         # 生成唯一 ID
     │
     └─── DefaultUniqueTokenIdGenerator
          ├── 组合生成器
          └── 使用 RandomStringGenerator

RandomStringGenerator (接口)
└── Base64RandomStringGenerator
     └── 生成 Base64 编码的随机字符串

NumericGenerator (接口)
└── LongNumericGenerator (接口)
     └── DefaultLongNumericGenerator
          └── 生成长整型数字
```

**关键源文件**:
- [`UniqueTokenIdGenerator`](imaping-token-api/src/main/java/com/imaping/token/api/generator/UniqueTokenIdGenerator.java:1)
- [`DefaultUniqueTokenIdGenerator`](imaping-token-api/src/main/java/com/imaping/token/api/generator/DefaultUniqueTokenIdGenerator.java:1)
- [`Base64RandomStringGenerator`](imaping-token-api/src/main/java/com/imaping/token/api/generator/Base64RandomStringGenerator.java:1)

---
