# 5. 数据流与交互

### 5.1 Token 创建流程

```
┌─────────────┐
│   业务代码   │
└──────┬──────┘
       │ 1. 调用 TokenFactory.createToken(authentication)
       ▼
┌─────────────────────┐
│    TokenFactory     │
│ (工厂选择器)         │
└──────┬──────────────┘
       │ 2. 委托给具体工厂
       ▼
┌─────────────────────┐
│ TimeoutTokenFactory │
│ 或                   │
│ HardTimeoutToken    │
│ Factory             │
└──────┬──────────────┘
       │ 3. 创建 Token 实例
       │    - 生成唯一 ID (UniqueTokenIdGenerator)
       │    - 设置过期策略 (ExpirationPolicy)
       │    - 绑定认证信息 (Authentication)
       ▼
┌─────────────────────┐
│      Token          │
│ (DefaultTimeout     │
│  AccessToken 或      │
│  DefaultHardTimeout │
│  Token)             │
└──────┬──────────────┘
       │ 4. 添加到注册表
       ▼
┌─────────────────────┐
│   TokenRegistry     │
│ (DefaultToken       │
│  Registry 或         │
│  RedisToken         │
│  Registry)          │
└──────┬──────────────┘
       │ 5. 持久化存储
       ▼
┌─────────────────────┐
│  ConcurrentHashMap  │
│   或 Redis           │
└─────────────────────┘
```

**关键代码路径**:
1. 业务代码调用: `tokenFactory.createToken(authentication)`
2. 工厂选择: [`DefaultTokenFactory.createToken()`](imaping-token-api/src/main/java/com/imaping/token/api/factory/DefaultTokenFactory.java:1)
3. ID 生成: [`DefaultUniqueTokenIdGenerator.getNewTokenId()`](imaping-token-api/src/main/java/com/imaping/token/api/generator/DefaultUniqueTokenIdGenerator.java:1)
4. 添加注册表: `tokenRegistry.addToken(token)`
5. 持久化: [`DefaultTokenRegistry.addTokenInternal()`](imaping-token-api/src/main/java/com/imaping/token/api/registry/DefaultTokenRegistry.java:1) 或 [`RedisTokenRegistry.addTokenInternal()`](imaping-token-redis-registry/src/main/java/com/imaping/token/redis/registry/RedisTokenRegistry.java:1)

### 5.2 Token 验证流程 (Spring Security 集成)

```
┌─────────────────────┐
│   HTTP 请求          │
│ (包含 Token)         │
└──────┬──────────────┘
       │
       ▼
┌─────────────────────────────────────┐
│  TokenAuthenticationFilter          │ ← 过滤器链
│  extends OncePerRequestFilter       │
└──────┬──────────────────────────────┘
       │ 1. 提取 Token
       │    - 从 Header (Authorization: Bearer <token>)
       │    - 从 Cookie (access_token)
       │    - 从 RequestParameter (?access_token=xxx)
       ▼
┌─────────────────────┐
│ 提取到 Token ID      │
└──────┬──────────────┘
       │ 2. 构造认证请求
       ▼
┌─────────────────────────────────────┐
│  DefaultBearerTokenAuthenticationToken│
└──────┬──────────────────────────────┘
       │ 3. 调用 AuthenticationManager
       ▼
┌─────────────────────────────────────┐
│  TokenAuthenticationProvider        │
└──────┬──────────────────────────────┘
       │ 4. 从注册表获取 Token
       ▼
┌─────────────────────┐
│   TokenRegistry     │
│ .getToken(tokenId)  │
└──────┬──────────────┘
       │ 5. 获取 Token
       ▼
┌─────────────────────┐
│      Token          │
└──────┬──────────────┘
       │ 6. 验证过期状态
       ▼
┌─────────────────────┐
│ ExpirationPolicy    │
│ .isExpired(token)   │
└──────┬──────────────┘
       │ 7. 验证结果
       ▼
    ┌───┴───┐
    │       │
    ▼       ▼
 ✅ 通过   ❌ 失败
    │       │
    │       └──→ 返回 401 Unauthorized
    ▼
┌─────────────────────┐
│ 更新 Token 使用状态  │
│ token.update()      │
└──────┬──────────────┘
       │ 8. 构造 Authentication
       ▼
┌─────────────────────────────────────┐
│  DefaultTokenAuthentication         │
│  - principal: Principal             │
│  - token: Token                     │
└──────┬──────────────────────────────┘
       │ 9. 设置到 SecurityContext
       ▼
┌─────────────────────┐
│  SecurityContext    │
│  .setAuthentication │
│   (authentication)  │
└──────┬──────────────┘
       │ 10. 继续过滤器链
       ▼
┌─────────────────────┐
│   业务处理器         │
└─────────────────────┘
```

**关键代码路径**:
1. 过滤器: [`TokenAuthenticationFilter.doFilterInternal()`](imaping-token-resource-client/src/main/java/com/imaping/token/resource/client/filter/TokenAuthenticationFilter.java:1)
2. 认证提供者: [`TokenAuthenticationProvider.authenticate()`](imaping-token-resource-client/src/main/java/com/imaping/token/resource/client/authentication/TokenAuthenticationProvider.java:1)
3. 注册表查询: `tokenRegistry.getToken(tokenId)`
4. 过期验证: `token.isExpired()`
5. 更新使用状态: `token.update()` → 更新 `lastTimeUsed`, `countOfUses`

### 5.3 Token 清理流程

```
┌─────────────────────────────────────┐
│  TokenSchedulingConfiguration       │ ← 调度配置
│  @EnableScheduling                  │
└──────┬──────────────────────────────┘
       │ 1. 配置定时任务
       │    (基于 imaping.token.scheduling.*)
       ▼
┌─────────────────────┐
│   定时调度器         │
│ @Scheduled          │
└──────┬──────────────┘
       │ 2. 触发清理任务
       ▼
┌─────────────────────────────────────┐
│  TokenRegistryCleaner               │
└──────┬──────────────────────────────┘
       │ 3. 清理过期 Token
       ▼
┌─────────────────────┐
│   TokenRegistry     │
│ .getTokens()        │
└──────┬──────────────┘
       │ 4. 遍历所有 Token
       ▼
┌─────────────────────┐
│   检查每个 Token     │
└──────┬──────────────┘
       │ 5. 判断是否过期
       ▼
┌─────────────────────┐
│ ExpirationPolicy    │
│ .isExpired(token)   │
└──────┬──────────────┘
       │ 6. 删除过期 Token
       ▼
┌─────────────────────┐
│   TokenRegistry     │
│ .deleteToken(id)    │
└─────────────────────┘
```

**关键代码路径**:
1. 调度配置: [`TokenSchedulingConfiguration`](imaping-token-api/src/main/java/com/imaping/token/api/config/TokenSchedulingConfiguration.java:1)
2. 清理器: [`DefaultTokenRegistryCleaner.clean()`](imaping-token-api/src/main/java/com/imaping/token/api/registry/DefaultTokenRegistryCleaner.java:1)

**配置项**:
```yaml
imaping:
  token:
    scheduling:
      enabled: true                 # 启用调度
      pool-size: 5                  # 线程池大小
      repeatInterval: 120000        # 清理间隔(毫秒)
      startDelay: 15000             # 启动延迟(毫秒)
```

### 5.4 自动配置加载顺序

```
1. IMapingPropertiesConfiguration
   └── 加载 @ConfigurationProperties("imaping")
        │
        ├─ IMapingConfigurationProperties
        ├─ TokenConfigurationProperties
        ├─ TokenRegistryProperties
        └─ AccessTokenProperties

2. TokenConfig (@AutoConfigureBefore TokenApiConfig)
   └── 条件创建 RedisTokenRegistry
       (条件: imaping.token.registry.redis.enabled=true)

3. TokenApiConfig (@AutoConfigureBefore TokenCoreAutoConfig)
   ├── tokenIdGenerator (UniqueTokenIdGenerator)
   ├── tokenRegistryLockRepository (LockRepository)
   ├── accessTokenExpirationPolicy (ExpirationPolicyBuilder)
   ├── hardTimeoutExpirationPolicy (HardTimeoutExpirationPolicyBuilder)
   ├── timeoutTokenFactory (TimeoutTokenFactory)
   ├── hardTimeoutTokenFactory (HardTimeoutTokenFactory)
   ├── defaultTokenFactory (TokenFactory)
   ├── tokenRegistry (TokenRegistry) - 默认内存实现
   └── tokenUserInfoContext (UserInfoContext)

4. TokenCoreAutoConfig
   ├── userInfoContext (UserInfoContext) - 如果未定义
   ├── securityUserInfoContext (SecurityUserInfoContext)
   └── securityContextUtil (SecurityContextUtil)

5. TokenSchedulingConfiguration
   └── Token 清理调度任务

6. ResourceClientConfig
   └── 扫描 @Aware 组件

7. TokenSecurityConfig
   ├── tokenAuthenticationProvider (TokenAuthenticationProvider)
   ├── tokenAuthenticationEntryPoint (TokenAuthenticationEntryPoint)
   └── apiFilterChain (SecurityFilterChain)
```

**自动配置文件位置**:
- `META-INF/spring.factories` (Spring Boot 2.7 之前)
- `META-INF/spring/org.springframework.boot.autoconfigure.AutoConfiguration.imports` (Spring Boot 2.7+)

---
